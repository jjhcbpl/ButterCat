<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å“ˆå‰ç±³æ•æ‰æŒ‘æˆ˜ ğŸ±</title>
    <style>
        /* å…¨å±€é‡ç½® & åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation; /* ä¼˜åŒ–è§¦æ‘¸ä½“éªŒï¼Œé˜²æ­¢åŒå‡»ç¼©æ”¾ */
        }

        /* èƒŒæ™¯å±‚ */
        .bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: url("bg.jpg") no-repeat center center;
            background-size: cover;
        }

        /* èƒŒæ™¯é®ç½©å±‚ */
        .bg-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            background-color: rgba(255, 255, 255, 0.7);
        }

        /* æ ¸å¿ƒå†…å®¹å±‚ */
        .content-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* æç¤ºä¿¡æ¯å¡ç‰‡ - æ¢å¤åˆå§‹æ˜¾ç¤ºï¼ˆå¼•å¯¼å±‚æ˜¾ç¤ºæ—¶åŒæ­¥å±•ç¤ºï¼‰ */
        .info-card {
            display: block; /* å…³é”®ä¿®æ”¹ï¼šä»noneæ”¹ä¸ºblockï¼Œé»˜è®¤æ˜¾ç¤º */
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px 14px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: #333;
            font-size: 13px;
            line-height: 1.5;
            max-width: 90%;
            text-align: center;
            z-index: 100;
        }

        .info-card strong {
            color: #e64398;
            font-size: 15px;
            display: block;
            margin-bottom: 4px;
        }

        /* å®æ—¶åˆ†æ•°æ˜¾ç¤ºï¼ˆç‹‚é£™æ—¶å±•ç¤ºï¼‰ */
        .real-time-score {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #ffd700;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            z-index: 100;
            display: none;
            touch-action: manipulation;
        }

        /* é“å…·é€‰æ‹©æ  - åº•éƒ¨å›ºå®šä¾¿äºæ‹‡æŒ‡æ“ä½œ */
        .prop-toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 12px 10px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 15px;
            z-index: 100;
            width: 90%;
            max-width: 400px;
            justify-content: space-around;
        }

        .prop-btn {
            padding: 12px 0;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            background-color: #f8e197;
            color: #6d4c41;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex: 1;
            min-width: 80px;
            touch-action: manipulation;
        }

        .prop-btn.active {
            background-color: #ffd700;
            box-shadow: 0 0 0 2px #daa520;
            color: #8b4513;
        }

        .prop-btn:active {
            transform: scale(0.95);
        }

        /* å“ˆå‰ç±³å®¹å™¨ - è‡ªé€‚åº”å°ºå¯¸ï¼ˆç¼©å°ä¸€åŠåï¼‰ */
        #hajimi-container {
            position: absolute;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s ease;
            z-index: 50;
            filter: drop-shadow(0 6px 8px rgba(0, 0, 0, 0.15));
            touch-action: manipulation;
        }

        #hajimi-container:active {
            transform: scale(1.1);
        }

        #hajimi-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 20px;
        }

        /* é“å…·é€šç”¨æ ·å¼ - ä¿æŒåŸæœ‰å°ºå¯¸ */
        .prop {
            position: absolute;
            width: 80px;
            height: 80px;
            z-index: 20;
            transition: all 0.2s ease;
            cursor: pointer;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.1));
            touch-action: manipulation;
        }

        .prop:active {
            transform: scale(0.9);
        }

        /* é“å…·å…·ä½“æ ·å¼ */
        .prop-cake {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='10' y='40' width='80' height='40' rx='10' fill='%23f8c471'/%3E%3Ccircle cx='50' cy='30' r='20' fill='%23ec7063'/%3E%3Ccircle cx='35' cy='25' r='5' fill='%23f1948a'/%3E%3Ccircle cx='50' cy='20' r='5' fill='%23f1948a'/%3E%3Ccircle cx='65' cy='25' r='5' fill='%23f1948a'/%3E%3C/svg%3E") no-repeat center;
            background-size: 70%;
        }

        .prop-box {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect x='10' y='10' width='80' height='80' rx='5' fill='%23e0d2b8' stroke='%238b6e46' stroke-width='3'/%3E%3Crect x='20' y='20' width='60' height='10' fill='%23c9b18f'/%3E%3Crect x='20' y='40' width='60' height='10' fill='%23c9b18f'/%3E%3Crect x='20' y='60' width='60' height='10' fill='%23c9b18f'/%3E%3C/svg%3E") no-repeat center;
            background-size: 70%;
        }

        .prop-toy {
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cline x1='50' y1='10' x2='50' y2='80' stroke='%238b4513' stroke-width='4'/%3E%3Ccircle cx='50' cy='10' r='10' fill='%23ff69b4'/%3E%3Ccircle cx='50' cy='10' r='5' fill='%23ff1493'/%3E%3C/svg%3E") no-repeat center;
            background-size: 70%;
        }

        /* æ–°æ‰‹å¼•å¯¼é®ç½© - å…³é”®ä¿®æ”¹ï¼šç¡®ä¿åˆå§‹æ˜¾ç¤ºï¼Œæå‡z-indexé˜²æ­¢è¢«è¦†ç›– */
        .guide-mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999; /* å¤§å¹…æå‡å±‚çº§ï¼Œé¿å…è¢«å…¶ä»–å…ƒç´ è¦†ç›– */
            display: flex; /* å¼ºåˆ¶åˆå§‹æ˜¾ç¤º */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .guide-mask h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #ffd700;
        }

        .guide-mask .rule-list {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: left;
            max-width: 300px;
        }

        .guide-mask .rule-list p {
            margin: 8px 0;
            font-size: 15px;
            line-height: 1.6;
        }

        .guide-mask .rule-list p span {
            color: #ffd700;
            font-weight: bold;
        }

        .guide-mask p.tips {
            margin: 10px 0 20px;
            font-size: 14px;
            color: #ccc;
        }

        .start-btn {
            margin-top: 10px;
            padding: 12px 30px;
            background-color: #ffd700;
            color: #8b4513;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
        }

        .start-btn:active {
            transform: scale(0.95);
        }

        /* åˆ†æ•°å¼¹çª—æ ·å¼ï¼ˆæ‰‹æœºç«¯é€‚é…ï¼‰ */
        .score-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 300;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .score-modal h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #ffd700;
        }

        .score-modal .score-value {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            color: #fff;
        }

        .score-modal .score-detail {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 30px;
        }

        .confirm-btn {
            padding: 14px 40px;
            background-color: #ffd700;
            color: #8b4513;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            min-width: 200px;
        }

        .confirm-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
<div class="bg-container"></div>
<div class="bg-mask"></div>
<div class="content-wrapper">
    <div class="info-card">
        <strong>å“ˆå‰ç±³æ•æ‰æŒ‘æˆ˜ ğŸ˜µ</strong>
        ç‚¹å‡»å“ˆå‰ç±³ â†’ ç‹‚é£™æ¨¡å¼<br>
        ğŸ‚ è›‹ç³•ï¼šå¸å¼•â†’ç¢°æ’æ¶ˆå¤±+åå¼¹<br>
        ğŸ“¦ çº¸ç®±ï¼šé’»è¿›å»æš‚åœâ†’1ç§’åé€€å‡º<br>
        ğŸª€ é€—çŒ«æ£’ï¼šç»•åœˆç§»åŠ¨â†’5ç§’åæ¶ˆå¤±<br>
        <small>æ“ä½œï¼šé€‰é“å…· â†’ ç‚¹å±å¹•æ”¾ç½®/ç§»é™¤</small>
    </div>

    <!-- å®æ—¶åˆ†æ•°æ˜¾ç¤º -->
    <div class="real-time-score" id="realTimeScore">åˆ†æ•°ï¼š0.0</div>

    <div class="prop-toolbar">
        <button class="prop-btn" data-type="cake">ğŸ‚ è›‹ç³•</button>
        <button class="prop-btn" data-type="box">ğŸ“¦ çº¸ç®±</button>
        <button class="prop-btn" data-type="toy">ğŸª€ é€—çŒ«æ£’</button>
    </div>

    <div id="hajimi-container">
        <img id="hajimi-img" src="hajimi.gif" alt="å“ˆå‰ç±³">
        <audio id="hajimi-song" loop>
            <source src="hajimi.mp3" type="audio/mpeg">
        </audio>
    </div>

    <div id="prop-container"></div>
</div>

<!-- æ–°æ‰‹å¼•å¯¼ï¼ˆè§„åˆ™å¼¹çª—ï¼‰- ç¡®ä¿DOMç»“æ„å®Œæ•´ï¼Œåˆå§‹æ˜¾ç¤º -->
<div class="guide-mask" id="guideMask">
    <h2>å“ˆå‰ç±³æ•æ‰æŒ‘æˆ˜ ğŸ±</h2>
    <div class="rule-list">
        <p>âœ¨ <span>åŸºç¡€ç©æ³•</span>ï¼šç‚¹å‡»å“ˆå‰ç±³å¼€å¯ç‹‚é£™æ¨¡å¼</p>
        <p>ğŸ‚ <span>è›‹ç³•</span>ï¼šå¸å¼•å“ˆå‰ç±³â†’ç¢°æ’åç«‹å³æ¶ˆå¤±+åå¼¹ï¼ˆ+0.2åˆ†ï¼‰</p>
        <p>ğŸ“¦ <span>çº¸ç®±</span>ï¼šå“ˆå‰ç±³é’»è¿›å»æš‚åœâ†’1ç§’åç®±å­æ¶ˆå¤±ï¼ˆ+0.9åˆ†ï¼‰</p>
        <p>ğŸª€ <span>é€—çŒ«æ£’</span>ï¼šå“ˆå‰ç±³ç»•åœˆç§»åŠ¨â†’æ”¾ç½®5ç§’åæ¶ˆå¤±ï¼ˆ+0.9åˆ†ï¼‰</p>
        <p>â±ï¸ <span>æ—¶é—´è®¡åˆ†</span>ï¼šç‹‚é£™æ¨¡å¼ä¸‹æ¯ç§’+0.1åˆ†ï¼ˆç´§å¼ æ„Ÿæ‹‰æ»¡ï¼ï¼‰</p>
        <p>ğŸ® <span>æ“ä½œ</span>ï¼šé€‰é“å…· â†’ ç‚¹å±å¹•æ”¾ç½®/ç§»é™¤</p>
        <p>ğŸ† <span>è®¡åˆ†è§„åˆ™</span>ï¼šç¬¬äºŒæ¬¡ç‚¹å‡»å“ˆå‰ç±³æ˜¾ç¤ºæ€»åˆ†å¹¶æš‚åœ</p>
    </div>
    <p class="tips">å¼€å§‹åè§„åˆ™é¢æ¿å°†è‡ªåŠ¨éšè—</p>
    <button class="start-btn" id="startBtn">å¼€å§‹æ¸¸æˆ</button>
</div>

<!-- åˆ†æ•°å¼¹çª— -->
<div class="score-modal" id="scoreModal">
    <h3>æŒ‘æˆ˜ç»“æŸ ğŸ‰</h3>
    <div class="score-value" id="scoreDisplay">0.0</div>
    <div class="score-detail">è›‹ç³•+0.2/ä¸ª | çº¸ç®±+0.9/ä¸ª | é€—çŒ«æ£’+0.9/ä¸ª | æ¯ç§’+0.1åˆ†</div>
    <button class="confirm-btn" id="confirmBtn">ç¡®å®šå¹¶é‡ç½®</button>
</div>

<script>
    // æ ¸å¿ƒå˜é‡
    const hajimiContainer = document.getElementById('hajimi-container');
    const hajimiSong = document.getElementById('hajimi-song');
    const propContainer = document.getElementById('prop-container');
    const propButtons = document.querySelectorAll('.prop-btn');
    const guideMask = document.getElementById('guideMask');
    const startBtn = document.getElementById('startBtn');
    const infoCard = document.querySelector('.info-card');
    // åˆ†æ•°ç›¸å…³å˜é‡
    const scoreModal = document.getElementById('scoreModal');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const confirmBtn = document.getElementById('confirmBtn');
    const realTimeScore = document.getElementById('realTimeScore');
    let score = 0; // æ€»åˆ†
    let clickCount = 0; // å“ˆå‰ç±³ç‚¹å‡»æ¬¡æ•°
    let isPaused = false; // æ˜¯å¦å› åˆ†æ•°é¢æ¿æš‚åœ
    let scoreTimer = null; // æ¯ç§’åŠ åˆ†å®šæ—¶å™¨

    // å“ˆå‰ç±³è‡ªé€‚åº”å°ºå¯¸é…ç½®ï¼ˆç¼©å°ä¸€åŠï¼‰
    let hajimiSize = 0; // åŠ¨æ€å­˜å‚¨å“ˆå‰ç±³å°ºå¯¸
    const MIN_HAJIMI_SIZE = 40;  // åŸ80 â†’ ç¼©å°ä¸º40
    const MAX_HAJIMI_SIZE = 60; // åŸ120 â†’ ç¼©å°ä¸º60
    const SIZE_RATIO = 0.075;     // åŸ0.15 â†’ ç¼©å°ä¸º0.075ï¼ˆå±å¹•å®½åº¦çš„7.5%ï¼‰

    // é“å…·è®¡åˆ†é…ç½®ï¼ˆçº¸ç®±/é€—çŒ«æ£’ä¸º0.9åˆ†ï¼‰
    const PROP_SCORE = {
        cake: 0.2,
        box: 0.9,
        toy: 0.9,
        time: 0.1
    };

    // å“ˆå‰ç±³ç§»åŠ¨é…ç½® - åŸºç¡€é€Ÿåº¦é€‚é…ï¼Œç‹‚é£™æ”¹ä¸º100å€ï¼ˆä¿æŒåŸæœ‰é€Ÿåº¦æ„Ÿï¼‰
    const baseSpeed = 0.8;
    let speedMultiplier = 1;
    let velX = getRandomVelocity();
    let velY = getRandomVelocity();
    let posX = 0;
    let posY = 0;
    let isPlaying = false;

    // é“å…·ç›¸å…³å˜é‡
    let selectedPropType = null;
    let props = [];
    let attractTarget = null;
    let isInBox = false;
    let toyTarget = null;
    let toyAngle = 0;
    let boxTimeout = null;
    let toyTimeouts = [];
    // æ–°å¢ï¼šéšæœºé€Ÿåº¦å®šæ—¶å™¨å¼•ç”¨ï¼ˆç”¨äºæš‚åœ/æ¢å¤ï¼‰
    let randomVelocityTimer = null;

    // ========== åˆ†æ•°è®¡ç®—å‡½æ•°ï¼ˆå…¼å®¹æ—¶é—´åŠ åˆ†ï¼‰ ==========
    function addScore(type, isTime = false) {
        const add = isTime ? PROP_SCORE.time : (PROP_SCORE[type] || 0);
        score += add;
        // ä¿ç•™1ä½å°æ•°ï¼Œé¿å…æµ®ç‚¹ç²¾åº¦é—®é¢˜
        score = Math.round(score * 10) / 10;
        // æ›´æ–°å®æ—¶åˆ†æ•°æ˜¾ç¤º
        updateRealTimeScore();
    }

    // ========== æ›´æ–°å®æ—¶åˆ†æ•°æ˜¾ç¤º ==========
    function updateRealTimeScore() {
        realTimeScore.textContent = `åˆ†æ•°ï¼š${score.toFixed(1)}`;
    }

    // ========== å¯åŠ¨/åœæ­¢æ¯ç§’åŠ åˆ†å®šæ—¶å™¨ ==========
    function startScoreTimer() {
        // å…ˆæ¸…é™¤æ—§å®šæ—¶å™¨ï¼Œé¿å…é‡å¤åˆ›å»º
        if (scoreTimer) clearInterval(scoreTimer);
        // æ¯ç§’åŠ 0.1åˆ†
        scoreTimer = setInterval(() => {
            if (isPlaying && !isPaused && !isInBox) { // ç‹‚é£™ä¸­ã€æœªæš‚åœã€æœªè¿›çº¸ç®±æ‰åŠ åˆ†
                addScore('', true);
            }
        }, 1000);
        // æ˜¾ç¤ºå®æ—¶åˆ†æ•°é¢æ¿
        realTimeScore.style.display = 'block';
        updateRealTimeScore();
    }

    function stopScoreTimer() {
        if (scoreTimer) {
            clearInterval(scoreTimer);
            scoreTimer = null;
        }
        // éšè—å®æ—¶åˆ†æ•°é¢æ¿
        realTimeScore.style.display = 'none';
    }

    // ========== æš‚åœå¹¶æ˜¾ç¤ºåˆ†æ•° ==========
    function pauseAndShowScore() {
        isPaused = true;
        // åœæ­¢æ—¶é—´åŠ åˆ†
        stopScoreTimer();
        // æš‚åœéšæœºé€Ÿåº¦ï¼ˆé¿å…æš‚åœæ—¶ä»æœ‰é€Ÿåº¦å˜åŒ–ï¼‰
        if (randomVelocityTimer) clearInterval(randomVelocityTimer);
        // æš‚åœå“ˆå‰ç±³ç§»åŠ¨
        velX = 0;
        velY = 0;
        // æš‚åœéŸ³é¢‘
        hajimiSong.pause();
        // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
        scoreDisplay.textContent = score.toFixed(1);
        // æ˜¾ç¤ºåˆ†æ•°å¼¹çª—
        scoreModal.style.display = 'flex';
    }

    // ========== é‡ç½®æ¸¸æˆçŠ¶æ€ ==========
    function resetGame() {
        // éšè—åˆ†æ•°å¼¹çª—
        scoreModal.style.display = 'none';
        // é‡ç½®åˆ†æ•°å’Œç‚¹å‡»æ¬¡æ•°
        score = 0;
        clickCount = 0;
        isPaused = false;
        // åœæ­¢æ—¶é—´åŠ åˆ†å®šæ—¶å™¨
        stopScoreTimer();
        // é‡ç½®å“ˆå‰ç±³çŠ¶æ€
        isPlaying = false;
        speedMultiplier = 1;
        velX = getRandomVelocity();
        velY = getRandomVelocity();
        resetHajimiPos();
        // æ¸…ç©ºæ‰€æœ‰é“å…·
        props.forEach(prop => {
            if (prop.timeoutId) clearTimeout(prop.timeoutId);
            prop.element.remove();
        });
        props = [];
        // æ¸…ç©ºé“å…·é€‰ä¸­çŠ¶æ€
        propButtons.forEach(btn => btn.classList.remove('active'));
        selectedPropType = null;
        // é‡ç½®é“å…·ç›¸å…³çŠ¶æ€
        attractTarget = null;
        isInBox = false;
        toyTarget = null;
        toyAngle = 0;
        if (boxTimeout) clearTimeout(boxTimeout);
        toyTimeouts.forEach(id => clearTimeout(id));
        toyTimeouts = [];
        // é‡ç½®å“ˆå‰ç±³æ ·å¼
        hajimiContainer.style.filter = "drop-shadow(0 6px 8px rgba(0, 0, 0, 0.15))";
        // é‡ç½®éŸ³é¢‘
        hajimiSong.currentTime = 0;
        // é‡ç½®å®æ—¶åˆ†æ•°æ˜¾ç¤º
        updateRealTimeScore();
        // æ¢å¤éšæœºé€Ÿåº¦å®šæ—¶å™¨
        if (!randomVelocityTimer) {
            randomVelocityTimer = setInterval(randomizeVelocity, 1500);
        }
    }

    // ========== å“ˆå‰ç±³å°ºå¯¸è‡ªé€‚åº”ï¼ˆç¼©å°åï¼‰ ==========
    function calcHajimiSize() {
        const screenWidth = window.innerWidth;
        const calcSize = Math.min(
            Math.max(screenWidth * SIZE_RATIO, MIN_HAJIMI_SIZE),
            MAX_HAJIMI_SIZE
        );
        return Math.floor(calcSize);
    }

    function setHajimiSize() {
        hajimiSize = calcHajimiSize();
        hajimiContainer.style.width = `${hajimiSize}px`;
        hajimiContainer.style.height = `${hajimiSize}px`;
        resetHajimiPos();
    }

    function resetHajimiPos() {
        posX = Math.random() * (window.innerWidth - hajimiSize);
        posY = Math.random() * (window.innerHeight - hajimiSize);
        hajimiContainer.style.left = `${posX}px`;
        hajimiContainer.style.top = `${posY}px`;
    }

    // ========== ç”Ÿæˆéšæœºåˆå§‹é€Ÿåº¦ ==========
    function getRandomVelocity() {
        return (Math.random() - 0.5) * 2 * baseSpeed;
    }

    // ========== è°ƒæ•´é€Ÿåº¦éšæœºåŒ–é¢‘ç‡ï¼ˆä¼˜åŒ–ï¼šä»…æ— å®šå‘çŠ¶æ€æ—¶ç”Ÿæ•ˆï¼‰ ==========
    function randomizeVelocity() {
        // å…³é”®ä¼˜åŒ–ï¼šåªæœ‰å½“å“ˆå‰ç±³æ— ä»»ä½•å®šå‘çŠ¶æ€æ—¶ï¼Œæ‰å åŠ éšæœºé€Ÿåº¦
        if (isPaused || isInBox || attractTarget || toyTarget) return;

        const randomDeltaX = (Math.random() - 0.5) * 0.4 * speedMultiplier; // é™ä½éšæœºåç§»å¹…åº¦ï¼ˆä»0.8â†’0.4ï¼‰
        const randomDeltaY = (Math.random() - 0.5) * 0.4 * speedMultiplier;

        velX += randomDeltaX;
        velY += randomDeltaY;

        const maxSpeed = 2.5 * speedMultiplier;
        const minSpeed = 0.4 * speedMultiplier;
        velX = Math.max(-maxSpeed, Math.min(maxSpeed, velX));
        velY = Math.max(-maxSpeed, Math.min(maxSpeed, velY));
    }

    // ========== é“å…·é€‰æ‹© ==========
    propButtons.forEach(btn => {
        btn.addEventListener('click', handlePropSelect);
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handlePropSelect.call(btn);
        });
    });

    function handlePropSelect() {
        const isActive = this.classList.contains('active');
        propButtons.forEach(b => b.classList.remove('active'));

        if (isActive) {
            selectedPropType = null;
        } else {
            this.classList.add('active');
            selectedPropType = this.dataset.type;
        }
    }

    // ========== æ”¾ç½®é“å…·ï¼ˆåŠ åˆ†é€»è¾‘ï¼‰ ==========
    document.addEventListener('click', handlePlaceProp);
    document.addEventListener('touchstart', (e) => {
        if (e.touches.length !== 1) return;
        const touch = e.touches[0];
        handlePlaceProp({
            clientX: touch.clientX,
            clientY: touch.clientY,
            target: document.elementFromPoint(touch.clientX, touch.clientY)
        });
    });

    function handlePlaceProp(e) {
        if (isPaused) return;

        const ignoreElements = [
            hajimiContainer,
            ...propButtons,
            infoCard,
            document.querySelector('.prop-toolbar'),
            guideMask,
            scoreModal,
            realTimeScore
        ];
        if (ignoreElements.some(el => el.contains(e.target)) || !selectedPropType) return;

        const prop = document.createElement('div');
        prop.className = `prop prop-${selectedPropType}`;
        prop.dataset.type = selectedPropType;
        const propWidth = 80;
        const propX = e.clientX - propWidth/2;
        const propY = e.clientY - propWidth/2;
        prop.style.left = `${Math.max(0, Math.min(propX, window.innerWidth - propWidth))}px`;
        prop.style.top = `${Math.max(0, Math.min(propY, window.innerHeight - propWidth))}px`;

        propContainer.appendChild(prop);
        const propObj = {
            element: prop,
            type: selectedPropType,
            x: parseInt(prop.style.left),
            y: parseInt(prop.style.top),
            width: propWidth,
            height: propWidth,
            timeoutId: null
        };
        props.push(propObj);

        // æ”¾ç½®é“å…·åŠ åˆ†
        addScore(selectedPropType);

        if (selectedPropType === 'toy') {
            const toyTimeout = setTimeout(() => {
                removeProp(prop);
            }, 5000);
            propObj.timeoutId = toyTimeout;
            toyTimeouts.push(toyTimeout);
        }

        prop.addEventListener('click', (e) => {
            e.stopPropagation();
            removeProp(prop);
        });
        prop.addEventListener('touchstart', (e) => {
            e.stopPropagation();
            e.preventDefault();
            removeProp(prop);
        });
    }

    // ========== ç§»é™¤é“å…· ==========
    function removeProp(propElement) {
        const index = props.findIndex(p => p.element === propElement);
        if (index > -1) {
            const prop = props[index];
            if (prop.type === 'cake' && attractTarget === prop) {
                attractTarget = null;
                // è›‹ç³•æ¶ˆå¤±åï¼Œæ¢å¤éšæœºé€Ÿåº¦ï¼ˆå»¶è¿Ÿä¸€ç‚¹ï¼Œé¿å…ç«‹å³çªå˜ï¼‰
                setTimeout(() => {
                    velX = getRandomVelocity() * speedMultiplier;
                    velY = getRandomVelocity() * speedMultiplier;
                }, 200);
            }
            if (prop.type === 'box') {
                isInBox = false;
                if (boxTimeout) clearTimeout(boxTimeout);
            }
            if (prop.type === 'toy') {
                if (toyTarget === prop) toyTarget = null;
                if (prop.timeoutId) {
                    clearTimeout(prop.timeoutId);
                    toyTimeouts = toyTimeouts.filter(id => id !== prop.timeoutId);
                }
            }
            propElement.remove();
            props.splice(index, 1);
        }
    }

    // ========== ç¢°æ’æ£€æµ‹ï¼ˆé€‚é…å“ˆå‰ç±³ç¼©å°åçš„å°ºå¯¸ + ä¼˜åŒ–åå¼¹ï¼‰ ==========
    function checkPropCollision() {
        if (isPaused) return;

        if (attractTarget) {
            const hx = posX + hajimiSize/2;
            const hy = posY + hajimiSize/2;
            const cx = attractTarget.x + 40;
            const cy = attractTarget.y + 40;
            const distance = Math.hypot(hx - cx, hy - cy);

            // è›‹ç³•ç¢°æ’è·ç¦»ä»60æ”¹ä¸º30ï¼ˆé€‚é…ç¼©å°åçš„å“ˆå‰ç±³ï¼‰
            if (distance < 30) {
                // ä¼˜åŒ–åå¼¹é€Ÿåº¦ï¼šé™ä½å¹…åº¦ + å¹³æ»‘è¿‡æ¸¡
                const reboundSpeed = 1.5 * speedMultiplier; // ä»2.5â†’1.5ï¼Œé™ä½åå¼¹å¼ºåº¦
                velX = -(hx - cx) / distance * reboundSpeed;
                velY = -(hy - cy) / distance * reboundSpeed;
                // åå¼¹åç«‹å³æ¸…ç©ºå¸å¼•ç›®æ ‡ï¼Œé¿å…é‡å¤è§¦å‘
                const currentAttractTarget = attractTarget;
                attractTarget = null;
                // å»¶è¿Ÿç§»é™¤è›‹ç³•ï¼Œé¿å…è§†è§‰ä¸Šç¬é—´æ¶ˆå¤±
                setTimeout(() => {
                    removeProp(currentAttractTarget.element);
                }, 50);
            }
        }

        props.forEach(prop => {
            if (prop.type === 'box' && !isInBox) {
                const isCollide = (
                    posX < prop.x + prop.width &&
                    posX + hajimiSize > prop.x &&
                    posY < prop.y + prop.height &&
                    posY + hajimiSize > prop.y
                );
                if (isCollide) {
                    isInBox = true;
                    posX = prop.x + (prop.width - hajimiSize)/2;
                    posY = prop.y + (prop.height - hajimiSize)/2;
                    velX = 0;
                    velY = 0;

                    boxTimeout = setTimeout(() => {
                        removeProp(prop.element);
                        isInBox = false;
                        // é€€å‡ºçº¸ç®±åï¼Œå¹³æ»‘æ¢å¤é€Ÿåº¦
                        velX = getRandomVelocity() * speedMultiplier * 0.8;
                        velY = getRandomVelocity() * speedMultiplier * 0.8;
                    }, 1000);
                }
            }
        });

        props.forEach(prop => {
            if (prop.type === 'toy' && !toyTarget) {
                const isCollide = (
                    posX < prop.x + prop.width &&
                    posX + hajimiSize > prop.x &&
                    posY < prop.y + prop.height &&
                    posY + hajimiSize > prop.y
                );
                if (isCollide) {
                    toyTarget = prop;
                    toyAngle = 0;
                }
            }
        });
    }

    // ========== é“å…·æ•ˆæœå¤„ç†ï¼ˆä¼˜åŒ–è›‹ç³•å¸å¼•å¹³æ»‘åº¦ï¼‰ ==========
    function handlePropEffects() {
        if (isPaused) return;

        if (!attractTarget) {
            const cakeProps = props.filter(p => p.type === 'cake');
            if (cakeProps.length > 0) attractTarget = cakeProps[0];
        }
        if (attractTarget) {
            const hx = posX + hajimiSize/2;
            const hy = posY + hajimiSize/2;
            const cx = attractTarget.x + 40;
            const cy = attractTarget.y + 40;
            const distance = Math.hypot(hx - cx, hy - cy);

            // ä¼˜åŒ–å¸å¼•é€Ÿåº¦ï¼šå¢åŠ å¹³æ»‘ç³»æ•°ï¼Œé¿å…é€Ÿåº¦çªå˜
            const attractSmooth = 0.1; // å¹³æ»‘å› å­ï¼Œè¶Šå°è¶Šé¡ºæ»‘
            const targetVelX = (cx - hx) / distance * 1.2 * speedMultiplier; // ä»1.8â†’1.2ï¼Œé™ä½å¸å¼•é€Ÿåº¦
            const targetVelY = (cy - hy) / distance * 1.2 * speedMultiplier;
            // çº¿æ€§æ’å€¼å¹³æ»‘è¿‡æ¸¡åˆ°ç›®æ ‡é€Ÿåº¦
            velX = velX * (1 - attractSmooth) + targetVelX * attractSmooth;
            velY = velY * (1 - attractSmooth) + targetVelY * attractSmooth;
        }

        if (isInBox) {
            velX = 0;
            velY = 0;
        }

        if (toyTarget) {
            toyAngle += 0.08 * speedMultiplier; // ä»0.1â†’0.08ï¼Œé™ä½ç»•åœˆé€Ÿåº¦
            // é€—çŒ«æ£’ç»•åœˆåŠå¾„ä»80æ”¹ä¸º40ï¼ˆé€‚é…ç¼©å°åçš„å“ˆå‰ç±³ï¼‰
            const radius = 40 * (speedMultiplier > 1 ? 1.5 : 1);
            const tx = toyTarget.x + 40;
            const ty = toyTarget.y + 40;
            posX = tx - hajimiSize/2 + Math.cos(toyAngle) * radius;
            posY = ty - hajimiSize/2 + Math.sin(toyAngle) * radius;
            posX = Math.max(0, Math.min(posX, window.innerWidth - hajimiSize));
            posY = Math.max(0, Math.min(posY, window.innerHeight - hajimiSize));
        }
    }

    // ========== å“ˆå‰ç±³ç§»åŠ¨ ==========
    function move() {
        handlePropEffects();
        checkPropCollision();

        if (!isPaused && !isInBox && !toyTarget) {
            posX += velX;
            posY += velY;

            if (posX + hajimiSize > window.innerWidth || posX < 0) {
                // ä¼˜åŒ–è¾¹ç¼˜åå¼¹ï¼šé™ä½åå¼¹ç³»æ•°ï¼Œé¿å…é€Ÿåº¦çªå˜
                velX = -velX * (0.6 + Math.random() * 0.2); // ä»0.8â†’0.6ï¼Œæ›´æŸ”å’Œ
                posX = Math.max(0, Math.min(posX, window.innerWidth - hajimiSize));
            }
            if (posY + hajimiSize > window.innerHeight || posY < 0) {
                velY = -velY * (0.6 + Math.random() * 0.2);
                posY = Math.max(0, Math.min(posY, window.innerHeight - hajimiSize));
            }
        }

        hajimiContainer.style.left = posX + 'px';
        hajimiContainer.style.top = posY + 'px';

        requestAnimationFrame(move);
    }

    // ========== å“ˆå‰ç±³ç‚¹å‡»äº‹ä»¶ï¼ˆç»Ÿè®¡æ¬¡æ•°+ç¬¬äºŒæ¬¡ç‚¹å‡»æ˜¾åˆ†ï¼‰ ==========
    hajimiContainer.addEventListener('click', toggleHajimiState);
    hajimiContainer.addEventListener('touchstart', (e) => {
        e.preventDefault();
        toggleHajimiState();
    });

    function toggleHajimiState() {
        if (isPaused) return;

        clickCount++;

        // ç¬¬äºŒæ¬¡ç‚¹å‡»ï¼šæš‚åœå¹¶æ˜¾ç¤ºåˆ†æ•°
        if (clickCount === 2) {
            pauseAndShowScore();
            return;
        }

        // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼šæ­£å¸¸å¼€å¯/å…³é—­ç‹‚é£™æ¨¡å¼
        if (!isPlaying) {
            hajimiSong.play().catch(e => alert("è¯·å…ˆç‚¹å‡»å¼€å§‹æ¸¸æˆæŒ‰é’®æ¿€æ´»éŸ³é¢‘æƒé™ï½"));
            isPlaying = true;
            speedMultiplier = 100;
            velX *= 100;
            velY *= 100;
            hajimiContainer.style.filter = "drop-shadow(0 8px 12px rgba(230, 67, 152, 0.3))";
            // å¯åŠ¨æ¯ç§’åŠ åˆ†å®šæ—¶å™¨
            startScoreTimer();
        } else {
            hajimiSong.pause();
            hajimiSong.currentTime = 0;
            isPlaying = false;
            speedMultiplier = 1;
            // ä¼˜åŒ–é€Ÿåº¦æ¢å¤ï¼šå¹³æ»‘é™ä½ï¼Œé¿å…ç¬é—´å‡é€Ÿ
            velX = velX / 100 * 0.5; // å…ˆé™åˆ°50%ï¼Œå†é€æ­¥æ¢å¤
            velY = velY / 100 * 0.5;
            hajimiContainer.style.filter = "drop-shadow(0 6px 8px rgba(0, 0, 0, 0.15))";
            // åœæ­¢æ¯ç§’åŠ åˆ†å®šæ—¶å™¨
            stopScoreTimer();
        }
    }

    // ========== ç¡®å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆé‡ç½®æ¸¸æˆï¼‰ ==========
    confirmBtn.addEventListener('click', resetGame);
    confirmBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        resetGame();
    });

    // ========== çª—å£å¤§å°é€‚é… ==========
    window.addEventListener('resize', () => {
        setHajimiSize();

        props.forEach(prop => {
            prop.x = Math.max(0, Math.min(prop.x, window.innerWidth - prop.width));
            prop.y = Math.max(0, Math.min(prop.y, window.innerHeight - prop.height));
            prop.element.style.left = `${prop.x}px`;
            prop.element.style.top = `${prop.y}px`;
        });
    });

    // ========== æ¸…ç†å®šæ—¶å™¨ ==========
    window.addEventListener('beforeunload', () => {
        if (boxTimeout) clearTimeout(boxTimeout);
        toyTimeouts.forEach(id => clearTimeout(id));
        if (scoreTimer) clearInterval(scoreTimer);
        if (randomVelocityTimer) clearInterval(randomVelocityTimer); // æ¸…ç†éšæœºé€Ÿåº¦å®šæ—¶å™¨
    });

    // ========== æ–°æ‰‹å¼•å¯¼ - ç¡®ä¿ç‚¹å‡»å¼€å§‹åæ‰éšè— ==========
    startBtn.addEventListener('click', () => {
        guideMask.style.display = 'none'; // ä»…ç‚¹å‡»å¼€å§‹åéšè—è§„åˆ™å¼¹çª—
        infoCard.style.display = 'none';  // åŒæ—¶éšè—é¡¶éƒ¨æç¤ºå¡
        // å¯åŠ¨éšæœºé€Ÿåº¦å®šæ—¶å™¨ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
        randomVelocityTimer = setInterval(randomizeVelocity, 1500);
        // è§¦å‘ä¸€æ¬¡äº¤äº’ä»¥è·å–éŸ³é¢‘æƒé™
        hajimiSong.play().then(() => {
            hajimiSong.pause();
        }).catch(e => console.log('ç­‰å¾…ç”¨æˆ·äº¤äº’åå†æ’­æ”¾éŸ³é¢‘'));
    });

    // ========== åˆå§‹åŒ– ==========
    setHajimiSize();
    move();
    // åˆå§‹åŒ–æ—¶ä¸å¯åŠ¨éšæœºé€Ÿåº¦ï¼Œç­‰å¾…å¼€å§‹æ¸¸æˆåå†å¯åŠ¨
    // setInterval(randomizeVelocity, 1500);
</script>
</body>
</html>